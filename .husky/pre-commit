#!/bin/sh
# 增强的pre-commit钩子，提供详细的错误报告

set -e

echo "🔍 检查待提交文件..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

if [ -z "$STAGED_FILES" ]; then
  echo "✅ 没有需要格式化的文件"
  exit 0
fi

echo "📝 待处理文件: $(echo "$STAGED_FILES" | wc -l) 个"
echo "$STAGED_FILES" | sed 's/^/  - /'
echo ""

# 存储暂存更改的哈希以检测修改
STAGED_HASH=$(git diff --cached | sha256sum | cut -d' ' -f1)
PARTIALLY_STAGED=$(git diff --name-only)

# 暂存未暂存的更改以保留工作目录
echo "💾 保存工作区状态..."
git stash push --quiet --keep-index --message "pre-commit-stash" || true
STASHED=$?

# 运行Ultracite并捕获详细输出
echo "🔧 运行 Ultracite 代码检查和修复..."

# 捕获stdout和stderr并保留退出码
set +e # 暂时禁用错误退出功能，以便捕获输出信息。
ULTRACITE_OUTPUT=$(pnpm dlx ultracite fix 2>&1)
ULTRACITE_EXIT_CODE=$?
set -e # 重新启用错误退出功能

# 检查Ultracite是否发现了任何错误（即使这些错误是可以修复的）
if echo "$ULTRACITE_OUTPUT" | grep -q "Found [1-9]"; then
  ULTRACITE_EXIT_CODE=1
fi
STAGED_HASH_BEFORE=$(git diff --cached | sha256sum | cut -d' ' -f1)

# 重新暂存文件（Ultracite可能已修改它们）
if [ -n "$STAGED_FILES" ]; then
  echo "$STAGED_FILES" | while IFS= read -r file; do
    if [ -f "$file" ]; then
      git add "$file"
    fi
  done >/dev/null 2>&1
fi

# 检查Ultracite是否进行了任何更改
STAGED_HASH_AFTER=$(git diff --cached | sha256sum | cut -d' ' -f1)

# 恢复工作目录状态
if [ $STASHED -eq 0 ]; then
  echo "🔄 恢复工作区状态..."
  git stash pop --quiet || true

  # 如果文件被部分暂存，则恢复部分暂存
  if [ -n "$PARTIALLY_STAGED" ]; then
    for file in $PARTIALLY_STAGED; do
      if [ -f "$file" ] && echo "$STAGED_FILES" | grep -q "^$file$"; then
        git restore --staged "$file" 2>/dev/null || true
        git add -p "$file" </dev/null 2>/dev/null || git add "$file"
      fi
    done >/dev/null 2>&1
  fi
fi

# 报告结果
echo ""
echo "=== 🔍 Ultracite 执行结果 ==="

if [ $ULTRACITE_EXIT_CODE -eq 0 ]; then
  if [ "$STAGED_HASH_BEFORE" != "$STAGED_HASH_AFTER" ]; then
    echo "✅ 代码格式化完成"
    echo "🔧 已修复以下文件:"
    echo "$STAGED_FILES" | sed 's/^/  ✨ /'
  else
    echo "✅ 代码格式良好，无需修改"
  fi
else
  echo "❌ 代码检查失败！"
  echo ""
  echo "📋 详细错误信息:"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  printf '%s\n' "$ULTRACITE_OUTPUT"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ""
  echo "🔧 修复建议:"
  echo "   1. 检查上述错误信息并修复代码问题"
  echo "   2. 运行 'pnpm dlx ultracite fix' 手动修复格式问题"
  echo "   3. 修复后重新添加文件: git add <文件名>"
  echo "   4. 重新提交: git commit"
  echo ""
  echo "❌ 提交已阻止，请修复错误后重新提交"
  exit $ULTRACITE_EXIT_CODE
fi

echo ""
echo "🎉 Pre-commit 检查完成！"
